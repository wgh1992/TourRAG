<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourRAG - Viewpoint Search & Recommendation</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 20px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .search-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        input[type="text"],
        select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-label:hover {
            background: #e8e8e8;
            border-color: #667eea;
        }

        .file-upload-label svg {
            width: 24px;
            height: 24px;
            fill: #667eea;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn {
            padding: 14px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: flex-start;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
        }

        .results-container.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .results-header h2 {
            color: #333;
            font-size: 1.8rem;
        }

        .results-meta {
            color: #666;
            font-size: 0.9rem;
        }

        .query-intent {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .query-intent h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #555;
        }

        .intent-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            display: inline-block;
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #555;
        }

        .tag.primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .candidates-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .candidate-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            cursor: pointer;
        }

        .candidate-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .candidate-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .candidate-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .candidate-category {
            font-size: 0.85rem;
            color: #666;
            text-transform: capitalize;
        }

        .confidence-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .candidate-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 15px;
        }

        .candidate-tags .tag {
            font-size: 0.75rem;
            padding: 4px 10px;
        }

        .candidate-explanation {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }

        .satellite-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .satellite-item {
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            background: #fafafa;
        }

        .satellite-wrapper {
            position: relative;
            width: 100%;
            height: 200px;
        }

        .satellite-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .satellite-overlay {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .satellite-caption {
            padding: 8px;
            font-size: 0.85rem;
            color: #666;
            border-top: 1px solid #e0e0e0;
            background: #fff;
        }

        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .detail-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .detail-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .detail-close:hover {
            background: #e0e0e0;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            border-radius: 8px;
            padding: 15px;
            color: #c33;
            margin-top: 20px;
            display: none;
            font-weight: 500;
        }

        .error-message.active {
            display: block;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .connection-status.checking {
            background: #ff9800;
            color: white;
        }

        .map-container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: block;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .map-header h2 {
            color: #333;
            font-size: 1.8rem;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .map-controls button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .map-controls button:hover {
            background: #5568d3;
        }

        .map-controls select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .map-stats {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .candidates-list {
                grid-template-columns: 1fr;
            }

            .search-form {
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="connection-status checking" id="connectionStatus">
            üîÑ Checking connection...
        </div>

        <div class="header">
            <h1>üåç TourRAG</h1>
            <p>Viewpoint Search & Recommendation System</p>
        </div>

        <div class="search-container">
            <form class="search-form" id="searchForm">
                <div class="input-group">
                    <label for="userText">Search Query</label>
                    <input 
                        type="text" 
                        id="userText" 
                        name="userText" 
                        placeholder="e.g., 'Mount Fuji in winter' or 'Êò•Â§©ÁöÑÊ®±Ëä±ÂØ∫Â∫ô'"
                    >
                </div>

                <div class="input-group">
                    <label for="language">Language</label>
                    <select id="language" name="language">
                        <option value="auto">Auto-detect</option>
                        <option value="en">English</option>
                        <option value="zh">‰∏≠Êñá</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Upload Images (Optional)</label>
                    <div class="file-upload">
                        <input 
                            type="file" 
                            id="imageUpload" 
                            name="images" 
                            accept="image/*" 
                            multiple
                        >
                        <label for="imageUpload" class="file-upload-label">
                            <svg viewBox="0 0 24 24">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            <span>Choose Images</span>
                        </label>
                    </div>
                    <div class="image-preview" id="imagePreview"></div>
                </div>

                <div class="input-group">
                    <label for="topK">Number of Results</label>
                    <select id="topK" name="topK">
                        <option value="3">3</option>
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                    </select>
                </div>

                <button type="submit" class="search-btn" id="searchBtn">
                    üîç Search Viewpoints
                </button>
            </form>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Searching viewpoints...</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="results-container" id="resultsContainer">
            <div class="results-header">
                <h2>Search Results</h2>
                <div class="results-meta" id="resultsMeta"></div>
            </div>

            <div class="query-intent" id="queryIntent"></div>

            <div class="candidates-list" id="candidatesList"></div>
        </div>

        <div class="map-container" id="mapContainer">
            <div class="map-header">
                <h2>üåç Viewpoints Map</h2>
                <div class="map-controls">
                    <select id="mapLimit" onchange="loadMap()">
                        <option value="">Show All</option>
                        <option value="100">Show 100</option>
                        <option value="500">Show 500</option>
                        <option value="1000">Show 1000</option>
                    </select>
                    <button onclick="loadMap()">Refresh Map</button>
                </div>
            </div>
            <div id="map"></div>
            <div class="map-stats" id="mapStats">Loading viewpoints...</div>
        </div>
    </div>

    <div class="detail-modal" id="detailModal">
        <div class="detail-content" id="detailContent"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Auto-detect API base URL
        const API_BASE = window.location.origin;
        let uploadedImages = [];
        let map = null;
        let mapMarkers = [];

        // Handle image upload
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            uploadedImages = [];
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';

            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedImages.push({
                            file: file,
                            dataUrl: e.target.result
                        });

                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="Preview">
                            <button type="button" class="remove-btn" onclick="removeImage(${index})">√ó</button>
                        `;
                        preview.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            uploadedImages.forEach((img, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${img.dataUrl}" alt="Preview">
                    <button type="button" class="remove-btn" onclick="removeImage(${index})">√ó</button>
                `;
                preview.appendChild(previewItem);
            });
        }

        // Handle form submission
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userText = document.getElementById('userText').value;
            const language = document.getElementById('language').value;
            const topK = parseInt(document.getElementById('topK').value);

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('resultsContainer').classList.remove('active');
            document.getElementById('errorMessage').classList.remove('active');
            document.getElementById('searchBtn').disabled = true;

            try {
                const formData = new FormData();
                if (userText) {
                    formData.append('user_text', userText);
                }
                formData.append('language', language);
                formData.append('top_k', topK);

                // Add images
                uploadedImages.forEach(img => {
                    // Convert data URL back to blob
                    const blob = dataURLtoBlob(img.dataUrl);
                    formData.append('user_images', blob, img.file.name || 'image.jpg');
                });

                console.log('Sending request to:', `${API_BASE}/api/v1/query`);
                
                const response = await fetch(`${API_BASE}/api/v1/query`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        // Don't set Content-Type for FormData - browser will set it with boundary
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('Received response:', data);
                displayResults(data);

            } catch (error) {
                console.error('Error:', error);
                let errorMsg = error.message;
                if (error.message === 'Failed to fetch') {
                    errorMsg = 'Failed to connect to the server. Please make sure the server is running at ' + API_BASE;
                }
                showError(errorMsg);
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('searchBtn').disabled = false;
            }
        });

        function dataURLtoBlob(dataURL) {
            const arr = dataURL.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8arr], {type:mime});
        }

        function normalizeBboxFromPolygon(polygonCoords) {
            if (!Array.isArray(polygonCoords) || polygonCoords.length < 3) {
                return null;
            }
            const xCoords = polygonCoords.map(coord => coord[0]).filter(Number.isFinite);
            const yCoords = polygonCoords.map(coord => coord[1]).filter(Number.isFinite);
            if (xCoords.length === 0 || yCoords.length === 0) {
                return null;
            }
            return [
                Math.min(...xCoords),
                Math.min(...yCoords),
                Math.max(...xCoords),
                Math.max(...yCoords)
            ];
        }

        function parseNormalizedData(value) {
            if (!value) {
                return null;
            }
            try {
                return JSON.parse(decodeURIComponent(value));
            } catch (error) {
                return null;
            }
        }

        function drawBboxOverlay(imgEl, canvasEl) {
            if (!imgEl || !canvasEl) {
                return;
            }
            const bboxData = parseNormalizedData(imgEl.dataset.bbox);
            const polygonData = parseNormalizedData(imgEl.dataset.polygon);
            const bboxNormalized = bboxData || normalizeBboxFromPolygon(polygonData);
            if (!bboxNormalized || bboxNormalized.length !== 4) {
                return;
            }

            const rect = imgEl.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) {
                return;
            }

            canvasEl.width = rect.width;
            canvasEl.height = rect.height;

            const ctx = canvasEl.getContext('2d');
            ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
            ctx.strokeStyle = '#ff7a00';
            ctx.lineWidth = 3;

            const x = bboxNormalized[0] * rect.width;
            const y = bboxNormalized[1] * rect.height;
            const w = (bboxNormalized[2] - bboxNormalized[0]) * rect.width;
            const h = (bboxNormalized[3] - bboxNormalized[1]) * rect.height;

            ctx.strokeRect(x, y, w, h);
        }

        function renderSatelliteOverlays(container) {
            if (!container) {
                return;
            }
            const items = container.querySelectorAll('.satellite-wrapper');
            items.forEach(wrapper => {
                const img = wrapper.querySelector('img');
                const canvas = wrapper.querySelector('canvas');
                if (!img || !canvas) {
                    return;
                }

                const draw = () => drawBboxOverlay(img, canvas);
                img.addEventListener('load', draw);
                if (img.complete) {
                    draw();
                }

                if (typeof ResizeObserver !== 'undefined') {
                    const observer = new ResizeObserver(() => drawBboxOverlay(img, canvas));
                    observer.observe(wrapper);
                } else {
                    window.addEventListener('resize', draw);
                }
            });
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsMeta = document.getElementById('resultsMeta');
            const queryIntent = document.getElementById('queryIntent');
            const candidatesList = document.getElementById('candidatesList');

            // Update metadata
            resultsMeta.textContent = `Found ${data.candidates.length} results in ${data.execution_time_ms}ms`;

            // Display query intent
            const intent = data.query_intent;
            let intentHTML = '<h3>Query Intent</h3>';
            intentHTML += '<div class="intent-tags">';
            
            if (intent.name_candidates && intent.name_candidates.length > 0) {
                intentHTML += `<span class="tag primary">Names: ${intent.name_candidates.join(', ')}</span>`;
            }
            if (intent.query_tags && intent.query_tags.length > 0) {
                intent.query_tags.forEach(tag => {
                    intentHTML += `<span class="tag">${tag}</span>`;
                });
            }
            if (intent.season_hint && intent.season_hint !== 'unknown') {
                intentHTML += `<span class="tag primary">Season: ${intent.season_hint}</span>`;
            }
            if (intent.scene_hints && intent.scene_hints.length > 0) {
                intent.scene_hints.forEach(hint => {
                    intentHTML += `<span class="tag">${hint}</span>`;
                });
            }
            if (intent.geo_hints) {
                if (intent.geo_hints.place_name) {
                    intentHTML += `<span class="tag">üìç ${intent.geo_hints.place_name}</span>`;
                }
                if (intent.geo_hints.country) {
                    intentHTML += `<span class="tag">üåç ${intent.geo_hints.country}</span>`;
                }
            }
            
            intentHTML += '</div>';
            
            // Show MCP tool calls if available
            if (data.tool_calls && data.tool_calls.length > 0) {
                intentHTML += '<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">';
                intentHTML += '<h4 style="font-size: 0.9rem; color: #667eea; margin-bottom: 8px;">üîß MCP Reasoning Tools Used:</h4>';
                data.tool_calls.forEach(toolCall => {
                    intentHTML += `<div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">`;
                    intentHTML += `<strong>${toolCall.tool || 'extract_query_intent'}</strong>`;
                    if (toolCall.output && toolCall.output.query_intent) {
                        const tags = toolCall.output.query_intent.query_tags || [];
                        if (tags.length > 0) {
                            intentHTML += ` ‚Üí Extracted tags: ${tags.join(', ')}`;
                        }
                    }
                    intentHTML += `</div>`;
                });
                intentHTML += '</div>';
            }
            
            queryIntent.innerHTML = intentHTML;

            // Display candidates
            candidatesList.innerHTML = '';
            data.candidates.forEach(candidate => {
                const card = document.createElement('div');
                card.className = 'candidate-card';
                card.onclick = () => showViewpointDetail(candidate.viewpoint_id);

                let tagsHTML = '';
                if (candidate.visual_tags && candidate.visual_tags.length > 0) {
                    candidate.visual_tags.forEach(vt => {
                        vt.tags.forEach(tag => {
                            tagsHTML += `<span class="tag">${tag}</span>`;
                        });
                    });
                }

                card.innerHTML = `
                    <div class="candidate-header">
                        <div>
                            <div class="candidate-name">${candidate.name_primary}</div>
                            ${candidate.category_norm ? `<div class="candidate-category">${candidate.category_norm}</div>` : ''}
                        </div>
                        <div class="confidence-badge">${(candidate.match_confidence * 100).toFixed(0)}%</div>
                    </div>
                    ${tagsHTML ? `<div class="candidate-tags">${tagsHTML}</div>` : ''}
                    ${candidate.match_explanation ? `<div class="candidate-explanation">${candidate.match_explanation}</div>` : ''}
                `;

                candidatesList.appendChild(card);
            });

            resultsContainer.classList.add('active');
        }

        async function showViewpointDetail(viewpointId) {
            const modal = document.getElementById('detailModal');
            const content = document.getElementById('detailContent');
            
            modal.classList.add('active');
            content.innerHTML = '<div class="spinner"></div><p>Loading details...</p>';

            try {
                const response = await fetch(`${API_BASE}/api/v1/viewpoint/${viewpointId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                let html = `
                    <button class="detail-close" onclick="closeDetailModal()">√ó</button>
                    <h1>${data.name_primary}</h1>
                `;

                if (data.category_norm) {
                    html += `<p style="color: #666; margin-bottom: 20px;">${data.category_norm}</p>`;
                }

                const aboutText = data.wikipedia?.extract_text || data.wikipedia?.extract;
                if (aboutText) {
                    html += `
                        <div class="detail-section">
                            <h3>About</h3>
                            <p>${aboutText.substring(0, 500)}...</p>
                        </div>
                    `;
                }

                if (data.visual_tags && data.visual_tags.length > 0) {
                    html += '<div class="detail-section"><h3>Visual Tags</h3>';
                    data.visual_tags.forEach(vt => {
                        html += `
                            <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                <strong>${vt.season}</strong>: ${vt.tags.join(', ')}
                                <br><small style="color: #666;">Confidence: ${(vt.confidence * 100).toFixed(0)}%</small>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                if (data.historical_summary) {
                    html += `
                        <div class="detail-section">
                            <h3>Historical Summary</h3>
                            <p>${data.historical_summary}</p>
                        </div>
                    `;
                }

                if (data.historical_evidence && data.historical_evidence.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h3>History Details</h3>
                            <div style="display: grid; gap: 10px;">
                                ${data.historical_evidence.map(e => `
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px;">
                                        <div style="font-weight: 600; color: #555;">${e.source || 'source'}</div>
                                        ${e.reference ? `<div style="font-size: 0.85rem; color: #888;">${e.reference}</div>` : ''}
                                        ${e.text ? `<div style="margin-top: 6px; color: #666;">${e.text}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                const satelliteImages = data.satellite_images || [];
                if (satelliteImages.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h3>Satellite Images</h3>
                            <div class="satellite-grid">
                                ${satelliteImages.map(image => {
                                    const imageUrl = image.url
                                        ? (image.url.startsWith('http') ? image.url : `${API_BASE}${image.url}`)
                                        : '';
                                    const bboxValue = image.bbox_normalized || image.geo_bbox_normalized || null;
                                    const polygonValue = image.polygon_normalized_coords || image.polygon_normalized || null;
                                    const bboxAttr = bboxValue ? ` data-bbox="${encodeURIComponent(JSON.stringify(bboxValue))}"` : '';
                                    const polygonAttr = polygonValue ? ` data-polygon="${encodeURIComponent(JSON.stringify(polygonValue))}"` : '';
                                    const caption = image.caption || image.label || image.filename || 'Satellite image';
                                    return `
                                        <div class="satellite-item">
                                            <div class="satellite-wrapper">
                                                <img src="${imageUrl}" alt="${caption}"${bboxAttr}${polygonAttr}>
                                                <canvas class="satellite-overlay"></canvas>
                                            </div>
                                            <div class="satellite-caption">${caption}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                const wikidataQid = data.wikidata?.wikidata_qid || data.wikidata?.qid;
                if (data.wikidata && wikidataQid) {
                    html += `
                        <div class="detail-section">
                            <h3>Additional Information</h3>
                            <p>Wikidata QID: ${wikidataQid}</p>
                        </div>
                    `;
                }

                // Load and display images
                const commonsImages = (data.commons_assets || []).filter(asset => asset.has_image);
                const localImages = data.local_images || [];
                if (commonsImages.length > 0) {
                    html += '<div class="detail-section"><h3>Images</h3>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">';
                    
                    commonsImages.forEach(asset => {
                        const imageUrl = `${API_BASE}/api/v1/image/${asset.id}`;
                        html += `
                            <div style="border-radius: 8px; overflow: hidden; border: 2px solid #e0e0e0;">
                                <img src="${imageUrl}" 
                                     alt="${asset.caption || 'Viewpoint image'}" 
                                     style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                                     onclick="window.open('${imageUrl}', '_blank')"
                                     onerror="this.style.display='none'">
                                ${asset.caption ? `<div style="padding: 8px; font-size: 0.85rem; color: #666;">${asset.caption.substring(0, 50)}${asset.caption.length > 50 ? '...' : ''}</div>` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                } else if (localImages.length > 0) {
                    html += '<div class="detail-section"><h3>Images</h3>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">';

                    localImages.forEach(image => {
                        const imageUrl = `${API_BASE}${image.url}`;
                        html += `
                            <div style="border-radius: 8px; overflow: hidden; border: 2px solid #e0e0e0;">
                                <img src="${imageUrl}" 
                                     alt="Viewpoint image" 
                                     style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                                     onclick="window.open('${imageUrl}', '_blank')"
                                     onerror="this.style.display='none'">
                                <div style="padding: 8px; font-size: 0.85rem; color: #666;">${image.filename}</div>
                            </div>
                        `;
                    });

                    html += '</div></div>';
                } else {
                    // Try to load images separately if not included
                    try {
                        const imagesResponse = await fetch(`${API_BASE}/api/v1/viewpoint/${viewpointId}/images`);
                        if (imagesResponse.ok) {
                            const imagesData = await imagesResponse.json();
                            const fetchedCommons = (imagesData.images || []).filter(asset => asset.has_image);
                            if (fetchedCommons.length > 0) {
                                html += '<div class="detail-section"><h3>Images</h3>';
                                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">';
                                
                                fetchedCommons.forEach(asset => {
                                    const imageUrl = `${API_BASE}/api/v1/image/${asset.id}`;
                                    html += `
                                        <div style="border-radius: 8px; overflow: hidden; border: 2px solid #e0e0e0;">
                                            <img src="${imageUrl}" 
                                                 alt="${asset.caption || 'Viewpoint image'}" 
                                                 style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                                                 onclick="window.open('${imageUrl}', '_blank')"
                                                 onerror="this.style.display='none'">
                                            ${asset.caption ? `<div style="padding: 8px; font-size: 0.85rem; color: #666;">${asset.caption.substring(0, 50)}${asset.caption.length > 50 ? '...' : ''}</div>` : ''}
                                        </div>
                                    `;
                                });
                                
                                html += '</div></div>';
                            }
                        }
                        if (!html.includes('<h3>Images</h3>')) {
                            const localImagesResponse = await fetch(`${API_BASE}/api/v1/viewpoint/${viewpointId}/local-images`);
                            if (localImagesResponse.ok) {
                                const localImagesData = await localImagesResponse.json();
                                if (localImagesData.images && localImagesData.images.length > 0) {
                                    html += '<div class="detail-section"><h3>Images</h3>';
                                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">';

                                    localImagesData.images.forEach(image => {
                                        const imageUrl = `${API_BASE}${image.url}`;
                                        html += `
                                            <div style="border-radius: 8px; overflow: hidden; border: 2px solid #e0e0e0;">
                                                <img src="${imageUrl}" 
                                                     alt="Viewpoint image" 
                                                     style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                                                     onclick="window.open('${imageUrl}', '_blank')"
                                                     onerror="this.style.display='none'">
                                                <div style="padding: 8px; font-size: 0.85rem; color: #666;">${image.filename}</div>
                                            </div>
                                        `;
                                    });

                                    html += '</div></div>';
                                }
                            }
                        }
                    } catch (e) {
                        console.log('Could not load images:', e);
                    }
                }

                content.innerHTML = html;
                renderSatelliteOverlays(content);

            } catch (error) {
                content.innerHTML = `
                    <button class="detail-close" onclick="closeDetailModal()">√ó</button>
                    <p style="color: #c33;">Error loading details: ${error.message}</p>
                `;
            }
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = `Error: ${message}`;
            errorDiv.classList.add('active');
        }

        // Close modal on outside click
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDetailModal();
            }
        });

        // Check server health on page load
        async function checkServerHealth() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                statusEl.textContent = 'üîÑ Checking connection...';
                statusEl.className = 'connection-status checking';
                
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Server health check:', data);
                    statusEl.textContent = '‚úÖ Connected';
                    statusEl.className = 'connection-status connected';
                } else {
                    console.warn('Server health check failed:', response.status);
                    statusEl.textContent = '‚ùå Server error';
                    statusEl.className = 'connection-status disconnected';
                }
            } catch (error) {
                console.error('Server health check error:', error);
                statusEl.textContent = '‚ùå Disconnected';
                statusEl.className = 'connection-status disconnected';
                showError('Warning: Cannot connect to server. Please make sure the server is running at ' + API_BASE);
            }
        }

        // Check health on page load
        window.addEventListener('load', function() {
            checkServerHealth();
            // Initialize map after page loads
            setTimeout(initMap, 500);
        });

        // Initialize map
        function initMap() {
            if (map) {
                map.remove();
            }
            
            // Create map centered on world
            map = L.map('map').setView([20, 0], 2);
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Load viewpoints
            loadMap();
        }


        // Load viewpoints and display on map (optimized for performance)
        async function loadMap() {
            const mapStats = document.getElementById('mapStats');
            
            // Clear existing markers efficiently
            if (map && mapMarkers.length > 0) {
                const group = L.layerGroup(mapMarkers);
                map.removeLayer(group);
            }
            mapMarkers = [];
            
            mapStats.textContent = 'Loading viewpoints...';
            
            try {
                const limit = document.getElementById('mapLimit').value;
                const url = limit ? `${API_BASE}/api/v1/viewpoints/map?limit=${limit}` : `${API_BASE}/api/v1/viewpoints/map`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const viewpoints = data.viewpoints;
                
                mapStats.textContent = `Rendering ${viewpoints.length} viewpoints...`;
                
                // Use CircleMarker for better performance (lighter than regular markers)
                let bounds = [];
                let batch = [];
                const BATCH_SIZE = 200;
                
                for (let index = 0; index < viewpoints.length; index++) {
                    const viewpoint = viewpoints[index];
                    const lat = viewpoint.lat;
                    const lng = viewpoint.lng;
                    
                    if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        // Create lightweight circle marker
                        const marker = L.circleMarker([lat, lng], {
                            radius: 5,
                            fillColor: '#667eea',
                            color: '#fff',
                            weight: 1,
                            opacity: 0.8,
                            fillOpacity: 0.6
                        });
                        
                        // Simple popup - load details on click
                        marker.bindPopup(`<strong>${viewpoint.n}</strong><br><button onclick="showViewpointDetail(${viewpoint.id})" style="margin-top: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button>`, {
                            maxWidth: 200
                        });
                        
                        batch.push(marker);
                        bounds.push([lat, lng]);
                        
                        // Add markers in batches for better performance
                        if (batch.length >= BATCH_SIZE || index === viewpoints.length - 1) {
                            const batchGroup = L.layerGroup(batch);
                            batchGroup.addTo(map);
                            mapMarkers.push(...batch);
                            batch = [];
                            
                            // Use requestAnimationFrame to avoid blocking UI
                            if (index < viewpoints.length - 1) {
                                await new Promise(resolve => requestAnimationFrame(resolve));
                            }
                        }
                    }
                }
                
                // Fit map to show all markers
                if (bounds.length > 0) {
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 10 });
                }
                
                // Update stats
                mapStats.textContent = `Displaying ${viewpoints.length} viewpoints on map`;
                
            } catch (error) {
                console.error('Error loading map:', error);
                mapStats.textContent = `Error loading viewpoints: ${error.message}`;
            }
        }
    </script>
</body>
</html>

